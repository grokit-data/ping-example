user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    resolver 127.0.0.11;
    
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;

    keepalive_timeout  65;

    server {
        listen 3023;
        listen [::]:3023;

        # Proxy for the paranet broker.
        location ~ ^/api/paranet-broker/pncp.v1.Broker/(.*) {
            proxy_pass_request_headers on;
            proxy_read_timeout 9999h;
            proxy_send_timeout 9999h;
            proxy_request_buffering off;
            proxy_http_version 1.1;
            proxy_pass http://ping-example-broker-1:3131/pncp.v1.Broker/$1;
        }

        location ~ ^/api/paranet-broker/grpc.health.v1.Health/(.*) {
            proxy_pass_request_headers on;
            proxy_read_timeout 9999h;
            proxy_send_timeout 9999h;
            proxy_request_buffering off;
            proxy_http_version 1.1;
            proxy_pass http://ping-example-broker-1:3131/grpc.health.v1.Health/$1;
        }

        location ~ ^/api/paranet-broker/grpc/([^/]+)/(.*) {
            proxy_pass_request_headers on;
            proxy_read_timeout 9999h;
            proxy_send_timeout 9999h;
            proxy_request_buffering off;
            proxy_http_version 1.1;
            proxy_pass http://ping-example-broker-1:3131/$1/$2;
        }

        # Proxy for the paranet data service.
        location ~ ^/api/paranet-service/(.*) {
            proxy_pass_request_headers on;
            proxy_pass http://ping-example-service-1:3132/$1$is_args$args;
        }

        # Proxy for the paraflow debugger.
        location ~ ^/api/debugger/(.*) {
            add_header Access-Control-Allow-Origin *;
            proxy_pass_request_headers on;
            proxy_pass http://ping-example-debugger-1:80/api/debugger/$1$is_args$args;
        }

        #### Proxy for the various actors by name.

        # Paraflow debugger WebSocket
        location ~ ^/api/actors/([^/]+)/_debug/control$ {
            proxy_pass http://ping-example-$1-paraflow-1:3030/_debug/control;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
        }

        # Paraflow debugger WebSocket
        location ~ ^/api/actors/([^/]+)/_debug/logstream$ {
            proxy_pass http://ping-example-$1-paraflow-1:3030/_debug/logstream$is_args$args;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
        }
        # Paraflow REST API
        location ~ ^/api/actors/([^/]+)/(.*)$ {
            proxy_pass http://ping-example-$1-paraflow-1:3030/$2$is_args$args;
        }
        # Paraflow REST API
        location ~ ^/extern/actors/([^/]+)/(.*)$ {
            proxy_pass http://$1-paraflow-1:3030/$2$is_args$args;
        }
        # Proxy for the paracord service.
        location ~ ^/(.*)$ {
            proxy_pass_request_headers on;
            proxy_pass http://ping-example-paracord-1:80/$1$is_args$args;
        }
    }
}
